<!DOCTYPE html>
<html>
	<title>Friend UP</title>
	<head>
		<script onload="" src="/webclient/js/apps/api.js"></script>
		<meta id="oauth2_redirect_uri" name="oauth2_redirect_uri" content="{oauth2_redirect_uri}">
		<meta id="google-signin-client_id" name="google-signin-client_id" content="{google-signin-client_id}">
	</head>
	<body class="Loading" onload="loginNow()">
		<link rel="stylesheet" href="/webclient/css/extraLoginCSS.css"/>
		<style>
			#LoginElement button
			{
				height: 35px;
				background-color: #3e7eb6;
				color: white;
			}
			#LoginElement button.google
			{
				height: 45px;
				box-sizing: border-box;
				padding: 0;
				background-color: white;
				color: #95A5A6;
				border: 1px solid #BDC3C7;
				white-space: nowrap;
			}
			#LoginElement button.google:hover 
			{
				cursor: pointer;
			}
			#LoginElement button.google svg
			{
				margin-bottom: -4px;
				padding-right: 8px;
			}
			#LoginElement h1, #LoginElement label, #LoginElement button
			{
				text-transform: none;
				font-weight: bold;
			}
			#LoginElement #forgotPassword
			{
				font-size: 15px;
				line-height: 35px;
			}
			#LoginElement .forgotPassword p, #LoginElement #invalidLogin p
			{
				margin: 0;
			}
			#LoginElement #invalidLogin p > span
			{
				padding: 0 0 6px 0;
			}
			#LoginElement a, a:hover
			{
				color: #3e7eb6 !important;
				font-weight: bold !important;
			}
			#LoginElement hr
			{
				border: 0;
				border-top: 1px solid #BDC3C7;
				margin-top: 18px;
				margin-bottom: 18px;
				height: 0;
			}
		</style>
		<div id="LoginElement" style="visibility: hidden">
			<div class="VContentTop">
				<div class="Logo">
					Friend OS
				</div>
				<h1>
					Sign in to your Workspace
				</h1>
				<div class="Box">
					<form method="post" onsubmit="return false">
						<div class="HRow">
							<label id="UsernameLabel" for="Username">Username</label>
							<p>
								<input type="username" id="Username" class="FullWidth" onkeydown="Application.checkKeys(event)" autocapitalize="none" autocorrect="none" tabindex="1" />
							</p>
						</div>
						<div class="HRow MarginTop HideForPass">
							<label id="PasswordLabel" for="Password">Password</label>
							<p>
								<input type="password" id="Password" class="FullWidth" onkeydown="Application.checkKeys(event)"  tabindex="2" />
							</p>
						</div>
						<div class="HRow MarginTop">
							<div class="HContent50 InputHeight FloatLeft forgotPassword">
								<p>
									<a id="forgotPassword" style="cursor:pointer;" onclick="Application.forgotPassword()" tabindex="-1000">Forgot password ?</a>
								</p>
							</div>
							<div class="HContent50 InputHeight FloatLeft">
								<button id="loginButton" class="IconSmall fa-unlock" tabindex="4" onclick="Application.doLogin()">
									Sign in
								</button>
							</div>
						</div>
						<div class="HRow MarginTop">
							<div class="HContent100">
								<div id="invalidLogin" class="Padding"><p>&nbsp;</p></div>
							</div>
						</div>
						<input type="hidden" id="publickey" value="{publickey}"/>
					</form>
					<hr/>
					<div class="HRow MarginTop">
						<div class="HContent100">
							<button class="IconSmall fa-unlock google" tabindex="4" onclick="loginGoogle()">
								<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48" class="abcRioButtonSvg">
									<g>
										<path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
										<path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
										<path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
										<path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
										<path fill="none" d="M0 0h48v48H0z"></path>
									</g>
								</svg>
        						<span class="buttonText">Sign in with Google</span>
							</button>
						</div>
					</div>
					<hr/>
					<div class="HRow MarginTop BorderTop HideForPass" style="text-align:center">
						Don't have an account? <a href="/register" target="_blank">Sign Up</a>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			Application = {
				showLog: false,
				failedAttempt: false,
				passwordRecoveryMode: false,
				init: function( data )
				{
				},
				doLogin: function( e )
				{
					/*
						In password recivery mode we do stuff a bit differently...
					*/
					if( this.passwordRecoveryMode )
					{
						
						if( Trim( ge( 'Username' ).value ) == '')
						{
							ge( 'Username' ).focus();
							ge( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = 'Enter your username.';
							return;
						}
						ge( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = '';
						parent.Friend.User.ResetPassword( Trim( ge( 'Username' ).value ), function( result ){
							Application.forgotPassword();
							if( ge( 'Username' ).value.indexOf( '@' ) > 1 ) 
								ge( 'Username' ).value = '';
							ge( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = ( result == 'ok' ? 'Please check your inbox.' : 'Could not reset password.' );
						} );
						return;
					}
					
					// Don't do it many times while working!
					if( this.busy ) return;
					this.busy = true;
					
					if( this.failedAttempt )
					{
						ge( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = 'Logging in...';
					}
					
					// Track user's login
					if( typeof ga == 'function' ) ga( 'send', 'event', 'userloginattempt', Trim( ge( 'Username' ).value ) );
					parent.Friend.User.Init();
					let us = Trim( ge( 'Username' ).value );
					let pw = Trim( ge( 'Password' ).value )
					parent.Friend.User.Login( us, pw, false, function( result, answer )
					{
						let tmp = null;
						if( answer )
						{
							// Try to parse response answer
							try
							{
								tmp = JSON.parse( answer );
							}
							catch( e )
							{
								console.log( 'Answer was not in json format: ', answer );
							}
							if( tmp && tmp.response )
							{								//check for block....
								if( tmp.response.indexOf( 'account blocked until:' ) > -1 )
								{
									let ts = tmp.response.replace( 'account blocked until:', '' );
									if( parseInt( ts ) > 0 )
									{
										Application.errorMessage = 'Account blocked (try again after ' + new Date( ts * 1000 ).toLocaleString() + ')';
										showLoginError();  
										return;
									}
								}
							}
						}
						
						if( result == false )
						{
							showLoginError();
						}
						else if( result == 0 )
						{
							setTimeout( showLoginError, 1000 );
						}
						// Success!
						else
						{
							//track users login..
							if( typeof ga == 'function' )
							{
								ga( 'send', 'event', 'userloginsuccess', us );	
							}
							parent.Workspace.showDesktop();
							Application.busy = false;
						}
					}, e, { hashedPassword: ge( 'Password' ).hashed ? true : false } );
				},
				// Login overwrite ...
				loginExternal: function( params, token, callback )
				{
						
					var self = this;
					
					if( params && params['id_token'] && params['id_token_content'] )
					{
						if( !parent.Workspace.encryption.keys.server )
						{
							parent.Workspace.encryption.keys.server = ( ge( 'publickey' ) && ge( 'publickey' ).value ? { publickey: ge( 'publickey' ).value } : false );
						}
						
						if( !parent.Workspace.encryption.keys.server.publickey )
						{
							console.log( 'Server Key Missing:', parent.Workspace.encryption.keys.server );
							return;
						}
						
						var username = params['id_token_content']['sub'];
						var password = params['id_token_content']['kid'];
						
						if( password )
						{
							if( password.indexOf('HASHED') < 0 )
							{
								password = 'HASHED' + Sha256.hash( password );
							}
						}
						
						if( !parent.Workspace.encryption.keys.client )
						{
							parent.Workspace.encryption.setKeys( username, password );
						}
						
						if( Application.showLog ) console.log( {
							'username' : username,
							'password' : password,
							'nounce'   : params['id_token_content']['nonce'],
							'fullname' : params['id_token_content']['name'],
							'email'    : params['id_token_content']['email'],
							'lang'     : params['id_token_content']['locale']
						} );
						
						var m = new cAjax();
						m.open( 'POST', '/loginprompt/' + parent.Workspace.encryption.keys.client.publickey, true );
						
						// 1: Validate Friend Login ...
						
						if( !token )
						{
							m.addVar( 'encrypted', parent.Workspace.encryption.encryptRSA( JSON.stringify( {
								'username' : username,
								'password' : password,
								'nounce'   : params['id_token_content']['nonce'],
								'fullname' : params['id_token_content']['name'],
								'email'    : params['id_token_content']['email'],
								'lang'     : params['id_token_content']['locale']
							} ), parent.Workspace.encryption.keys.server.publickey ) );
						}
						
						// 2: Verify Google Login ...
						
						else
						{
							m.addVar( 'token', token );
						}
						
						m.addVar( 'deviceid', parent.Workspace.deviceid );
						
						// Set username and password so we can fetch it later
						let enc = parent.Workspace.encryption;
						parent.Workspace.storedCredentials = {
							username: enc.encrypt( username, enc.getKeys().publickey ),
							password: enc.encrypt( password, enc.getKeys().publickey )
						};
						
						m.onload = function()
						{
							
							var json = null; var serveranswer = null;
							
							if( this.responseText() )
							{
								var res = this.responseText().split( '<!--separate-->' );
								
								if( res && res[ 0 ] && res[ 1 ] )
								{
									
									if( res[ 2 ] )
									{
										try
										{
											serveranswer = parent.Workspace.encryption.decrypt( res[ 2 ] );
										
											json = JSON.parse( serveranswer );
										}
										catch( e ) 
										{
											console.log( e );
										}
									
										// We got a real error
										if( json == null )
										{
											if( callback && typeof( callback ) == 'function' ) callback( false );
										}
									}
									
									if( Application.showLog ) console.log( { json: json, serveranswer: serveranswer, raw: this.responseText() } );
									
									switch( res[ 1 ] )
									{
										
										// ok identity check ...
										
										case 'identity':
												
											if( res[0] == 'ok' )
											{
												self.loginExternal( params, params['id_token'], callback );
											}
											else
											{
												parent.Friend.User.SetUserConnectionState( 'offline' );
												
												if( callback && typeof( callback ) == 'function' ) return callback( false, serveranswer );
											}
											
											return;
										
										// ok verification ...
										
										case 'verification':
											
											if( res[ 0 ] == 'ok' && json && json.username && json.sessionid )
											{
												
												parent.Workspace.sessionId     = json.sessionid;
												parent.Workspace.loginUsername = json.username;
												parent.Workspace.loginUserId   = json.userid;
												parent.Workspace.loginid       = json.loginid;
												parent.Workspace.userLevel     = json.level;
												parent.Workspace.fullName      = json.fullname;
												
												// We are now online!
												parent.Friend.User.SetUserConnectionState( 'online' );
												
												if( !parent.Workspace.userWorkspaceInitialized )
												{
													return parent.Workspace.initUserWorkspace( json, ( callback && typeof( callback ) == 'function' ? callback( true, serveranswer ) : false ), event );
												}
												else
												{
													if( typeof( callback ) == 'function' ) return callback( true, serveranswer );
													// Make sure we didn't lose websocket!
												}
												
											}
											else
											{
												parent.Friend.User.SetUserConnectionState( 'offline' );
												
												if( callback && typeof( callback ) == 'function' ) return callback( false, serveranswer );
											}
											
											break;
										
										// if nothing expected run default ...
										
										default:
											
											if( callback && typeof( callback ) == 'function' ) return callback( false, serveranswer );
											
											break;
										
									}
								}
							}
							
							if( Application.showLog ) console.log( this.responseText() );
							
							if( callback && typeof( callback ) == 'function' ) callback( false );
							
						}
						m.send();
					}
					
					return 0;
					
				},
				checkKeys: function( e )
				{
					var k = e.which ? e.which : e.keyCode;
					if( k == 13 )
					{
						this.doLogin( e );
					}
				},
				receiveMessage: function( msg )
				{	
					// TODO: Remove if not in any use ...
					if( msg.command && msg.command == 'error' )
					{
						showLoginError();
					}
					else if( msg.cmd && msg.cmd == 'login' )
					{
						ge( 'Username' ).value = msg.username;
						ge( 'Password' ).value = msg.password;
						
						Application.loginUser( msg );
					}
				},
				loginUser: function( msg )
				{
					if( msg && parent && parent.Workspace && parent.Friend && parent.Friend.User )
					{
						parent.Friend.User.Init();
						parent.Workspace.setLogoutURL( msg.logouturl );
						
						this.doLogin(  );
					}
					else
					{
						showLoginError( 'Could not login' );
					}
				},
				forgotPassword : function()
				{
					ge( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = '';
					if( Application.passwordRecoveryMode )
					{
						Application.passwordRecoveryMode = false;
						ge( 'loginButton' ).classList.remove( 'FloatRight' );
						ge( 'loginButton' ).innerHTML = 'Sign in';
						ge( 'UsernameLabel' ).innerHTML = 'Username';
						ge( 'forgotPassword' ).innerHTML = 'Forgot password ?';
						document.querySelectorAll( '.HideForPass' ).forEach( function( thisNode ){
							thisNode.style.display = thisNode.dataset.oldDisplay;
						} );	
						ge('loginButton').classList.remove( 'Forgot' );
						return;
					}
					
					Application.passwordRecoveryMode = true;
					document.querySelectorAll( '.HideForPass' ).forEach( function( thisNode ){
						thisNode.dataset.oldDisplay = thisNode.style.display;
						thisNode.style.display = 'none';
					} );	
					ge( 'loginButton' ).classList.add( 'FloatRight' );
					ge( 'loginButton' ).innerHTML = ' &nbsp; Request new password';
					ge( 'loginButton' ).classList.add( 'Forgot' );
					ge( 'UsernameLabel' ).innerHTML = 'Username / e-mail:';
					ge( 'forgotPassword' ).innerHTML = 'Return to login form';
				}
			};
			
			function getRandomString( length ) 
			{
				var randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
				var result = '';
				for ( var i = 0; i < length; i++ ) {
					result += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
				}
				return result;
			}
			
			function externalAuth( callback )
			{
				
				// TODO: Look at how to do this without iframes ... perhaps can avoid popups ...
				
				if( location.href && location.href.indexOf( 'localhost' ) < 0 && location.href.indexOf( '?test' ) >= 0 )
				{
					return oauth2SignIn( callback );
				}
				else
				{
					return oauth2Window( callback );
				}
				
			}
			
			function oauth2Window( callback )
			{
				var CLIENT_ID = document.getElementById( 'google-signin-client_id' ).getAttribute( 'content' );
				var REDIRECT_URI = document.getElementById( 'oauth2_redirect_uri' ).getAttribute( 'content' );
				
				var SCOPES = [ 'openid', 'profile', 'email' ];
				
				var winw  = Math.min( 600, screen.availWidth );
				var winh = Math.min( 750, screen.availHeight );
				
				var lpos = Math.floor( ( screen.availWidth - winw ) / 2  );
				var tpos  = Math.floor( ( screen.availHeight - winh ) / 2  );
				
				// Google's OAuth 2.0 endpoint for requesting an access token
				var oauth2 = 'https://accounts.google.com/o/oauth2/v2/auth';
				
				var vars = '';
				
				// Parameters to pass to OAuth 2.0 endpoint.
				vars += '?redirect_uri=' + REDIRECT_URI;
				vars += '&client_id=' + CLIENT_ID;
				vars += '&nonce=' + getRandomString( 20 );
				vars += '&scope=' + SCOPES.join( ' ' );
				vars += '&response_type=token id_token';
				
				loginwindow = window.open( oauth2 + vars, 'authwindow', 'width=' + winw + ',height=' + winh + ',top=' + tpos + ',left=' + lpos );
				
				window.addEventListener( 'message', function( msg ) 
				{
					
					if( msg && msg.data.url )
					{
						var params = {}; var args = false;
						
						if( Application.showLog ) console.log( 'oauth msg: ', msg.data.url );
						
						if( msg.data.url.split( '#' )[1] )
						{
						    args = msg.data.url.split( '#' )[1].split( '&' );
						}
						else if( msg.data.url.split( '?' )[1] )
						{
						    args = msg.data.url.split( '?' )[1].split( '&' );
						}
						
					    if( args && args.length > 0 )
					    {
					        for( var key in args )
					        {
					            if( args[key] && args[key].split( '=' )[1] )
					            {
					                params[ args[key].split( '=' )[0] ] = args[key].split( '=' )[1];
					            }
					        }
					    }
						
						if( Application.showLog ) console.log( 'params: ', params );
						
						if( params && ( params['access_token'] || params[ 'id_token' ] ) )
						{
					   		getTokeninfo( params, function( data )
					   		{
					   			
					   			if( data )
					   			{
					   				if( callback && typeof( callback ) == 'function' ) return callback( data );
					   			}
					   			
					   		} );
						}
						
						if( loginwindow ) loginwindow.close();
						
						return params;
						
					}
		
				} );
				
			}
			
			function oauth2SignIn( callback )
			{
				console.log( 'init: oauth2SignIn( callback )' );
				
				var CLIENT_ID = document.getElementById( 'google-signin-client_id' ).getAttribute( 'content' );
				var REDIRECT_URI = location.href;
				
				var SCOPES = [ 'openid', 'profile', 'email' ];
				
				// Google's OAuth 2.0 endpoint for requesting an access token
				var oauth2 = 'https://accounts.google.com/o/oauth2/v2/auth';
				
				// Create element to open OAuth 2.0 endpoint in new window.
				var form = document.createElement( 'form' );
				form.setAttribute( 'method', 'GET' ); // Send as a GET request.
				form.setAttribute( 'action', oauth2 );
				
				// Parameters to pass to OAuth 2.0 endpoint.
				var params = {
					'client_id'              : CLIENT_ID,
					'nonce'                  : getRandomString( 20 ),
					'redirect_uri'           : REDIRECT_URI,
					'response_type'          : 'token id_token'
				};
				
				// Add form parameters as hidden input values.
				for ( var p in params ) 
				{
					var input = document.createElement( 'input' );
					input.setAttribute( 'type', 'hidden' );
					input.setAttribute( 'name', p );
					input.setAttribute( 'value', params[p] );
					form.appendChild( input );
				}
				
				// Add form to page and submit it to open the OAuth 2.0 endpoint.
				document.body.appendChild(form);
				form.submit();
			}
			
			function getTokeninfo( params, callback )
			{
				
				if ( params && ( params['access_token'] || params['id_token'] ) )
				{
					var xhr = new XMLHttpRequest();
					xhr.open('GET', 'https://oauth2.googleapis.com/tokeninfo' + ( params['id_token'] ? '?id_token=' + params['id_token'] : '' ) );
					
					if( !params['id_token'] && params['access_token'] )
					{
						xhr.setRequestHeader( 'Authorization', 'Bearer ' + params['access_token'] );
					}
					
					xhr.onreadystatechange = function ( e ) 
					{
						if( xhr.readyState === 4 && xhr.status === 200 ) 
						{
						    if( Application.showLog ) console.log( '[1] ' + xhr.response );
						    
						    try
						    {
						    	var data = JSON.parse( xhr.response );
						    	
						    	if( data )
						    	{
						    		params['id_token_content'] = data;
						    		
						    		callback( params );
						    	}
						    }
						    catch {  }
						} 
						else if ( xhr.readyState === 4 && xhr.status === 401 ) 
						{
						    console.log( '[2] ' + xhr.response );
						}
					};
					xhr.send(  );
				}
				
			}
			
			function loginGoogle( e )
			{
				var self = Application;
				
				// Don't do it many times while working!
				if( self.busy ) return;
				self.busy = true;
				
				var self = Application;
				
				externalAuth( function( params )
				{
					
					// Track user's login
					if( typeof ga == 'function' && params && params['id_token_content'] && params['id_token_content']['sub'] ) 
					{
						ga( 'send', 'event', 'userloginattempt', params['id_token_content']['sub'] );
					}
					
					parent.Friend.User.Init();
					
					self.loginExternal( params, null, function( result, answer )
					{
						
						let tmp = null;
						if( answer )
						{
							// Try to parse response answer
							try
							{
								tmp = JSON.parse( answer );
							}
							catch( e )
							{
								console.log( 'Answer was not in json format: ', answer );
							}
							if( tmp && tmp.response )
							{
								//check for block....
								if( tmp.response.indexOf( 'Account blocked until:' ) > -1 )
								{
									let ts = tmp.response.replace( 'Account blocked until:', '' );
									if( parseInt( ts ) > 0 )
									{
										Application.errorMessage = 'Account blocked (try again after ' + new Date( ts * 1000 ).toLocaleString() + ')';
										showLoginError();  
										return;
									}
								}
								if( !tmp.code )
								{
									showLoginError( tmp.response );
									return;
								}
							}
						}
						
						if( result == false )
						{
							showLoginError();
						}
						else if( result == 0 )
						{
							setTimeout( showLoginError, 1000 );
						}
						// Success!
						else
						{
							//track users login..
							if( typeof ga == 'function' && params && params['id_token_content'] && params['id_token_content']['sub'] )
							{
								ga( 'send', 'event', 'userloginsuccess', params['id_token_content']['sub'] );	
							}
							parent.Workspace.showDesktop();
							Application.busy = false;
						}
						
					} );
					
				} );
			}
			
			function signupForm(  )
			{
				// TODO: Add support for redirecting top layer window by adding support for flag 'allow-top-navigation' on the iframe.
				window.top.location.href = '/register';
			}
			
			function showLoginError( msg )
			{
				parent.Workspace.loginPrompt.setFlag( 'height', 263 );
				ge( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = ( 
					Application.errorMessage ? Application.errorMessage : ( 
						msg ? msg : 'Invalid credentials. Please check your input.'
					) 
				);
				Application.failedAttempt = true;
				Application.busy = false;
				ge( 'LoginElement' ).style.visibility = 'visible';
			}
			
			// Focus the username field
			function loginNow( e )
			{
				if( typeof( GetCookie ) == 'undefined' ) return setTimeout( loginNow, 50 );
				
				Application.applicationId = 'loginprompt';
				
				if( parent.GetUrlVar( 'username' ) )
				{
					ge( 'Username' ).value = parent.GetUrlVar( 'username' );
					ge( 'Password' ).value = parent.GetUrlVar( 'password' );
					ge( 'Password' ).hashed = true;
					Application.doLogin( e );
				}
				
				document.getElementById('LoginElement').style.visibility = 'visible';
				document.getElementById('Username').focus();
			}
			
		</script>
		<script type="text/javascript">
			if( document.location.href.indexOf( 'friendsky.cloud' ) >= 0 )
			{
				(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
				ga( 'create', 'UA-64441212-5', 'auto' );
				ga( 'send', 'pageview' );
				ga( 'send', 'event', 'logindisplay', document.location.href );
			}
		</script>
	</body>
</html>
