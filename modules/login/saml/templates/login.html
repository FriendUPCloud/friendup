<!DOCTYPE html>
<html>
	<head>
		<style>
			body
			{
				padding: 0;
				margin: 0;
			}
			html { color: #f8f8f8; background: #f8f8f8; }
			html body.Loading * { visibility: hidden; }
			html body.Loading { background-color: #f8f8f8; }
			h3 { padding-bottom:12px !important; }
			#SamlFormFrame { width:100%; height:30px; }
			#LoginElement
			{
				opacity: 1;
				transition: opacity 0.35s;
			}
			#LoginElement.Faded
			{
				opacity: 0;
			}
			.MarginBottom
			{
				margin-bottom: 10px;
			}
			.MarginTop
			{
				margin-top: 10px;
			}
			#AuthImage
			{
				position: relative;
				margin: -20px -20px 20px -20px;
				border: 0;
			}
		</style>
		<script src="/webclient/js/apps/api.js"></script>
	</head>
	<body class="Loading" onload="document.getElementById('LoginElement').style.visible = 'visible'; Application.init();">
		<div id="LoginElement" style="visible: hidden">
			<div class="VContentTop">
				<div class="Box">
					<div class="HRow"><h3>{welcome}</h3></div>
					<div class="HRow">
						<iframe id="SamlFormFrame" style="border:none; {additionaliframestyles}" src="{samlendpoint}"></iframe>
					</div>
					<div class="HRow">
						<p><br /><a href="{scriptpath}?module=fcdb" style="{additionalfriendlinkstyle}">{friendlinktext}</a></p>
					</div>
					<div class="HRow">
						<div id="invalidLogin"><p></p></div>
					</div>
				</div>
			</div>
		</div>
		<style>#invalidLogin { color:#F00; }</style>
		<script>
			Application = {
				failedAttempt: false,
				uName: false,
				uPass: false,
				pHash: false,
				logoutURL: false,
				loginAttempts: 0,
				init: function( data )
				{
					//parent.Workspace.loginPrompt.setFlag( 'height', 290 );
					//console.log('set it and will try again in half a second');
					//setTimeout( 'parent.Workspace.loginPrompt.setFlag( \'height\', 290 );',500 );
				},
				// Start the mobile 2fa validation process
				validateMobileNumber: function()
				{
					
				},
				doLogin: function( e )
				{
				
					console.log('execute login...');
					
				},
				checkKeys: function( e )
				{
					var k = e.which ? e.which : e.keyCode;
					if( k == 13 )
					{
						this.doLogin( e );
					}
				},
				receiveMessage: function( msg )
				{
					if( msg.cmd && msg.command == 'error' )
					{
						showLoginError();
					}
					else if( msg.cmd && msg.cmd == 'login' )
					{
						Application.uName = msg.username;
						Application.uPass = msg.password;
						Application.logoutURL = msg.logouturl;
						
					    // Execute the login procedure
						Application.loginUser();
					}
					
					// Store samldata on Workspace.samlData for later use
					if( msg.samldata ) 
					{
						parent.Workspace.samlData = msg.samldata;
					}
				},
				loginUser: function()
				{
				    // Make sure we have a unique identifier
				    if( !this.Auth2faToken )
				    {
				        this.Auth2faToken = md5( '2fa_' + ( Math.random() ) + '_' + ( Math.random() ) + ( new Date() ).getTime() );
				    }
				    let m = new cAjax();
				    m.open( 'POST', '/loginprompt/?check2fa=1&auth2fatoken=' + this.Auth2faToken, true );
				    m.onload = function()
				    {
				    	let resp = this.responseText().split( '<!--separate-->' );
				    	let e = resp[0]; let d = resp[1];
				        if( e == 'ok' )
				        {
					        if( parent && parent.Workspace && parent.Friend && parent.Friend.User )
					        {
						        // Don't do it many times while working!
						        if( Application.busy ) return;
						        Application.busy = true;
						        
						        if( Application.uPass.indexOf( 'HASHED' ) >= 0 || Application.uPass.indexOf( '{S6}' ) >= 0 )
						        {
							        Application.pHash = true;
						        }
						        
						        parent.Friend.User.Init();
						        parent.Workspace.setLogoutURL( Application.logoutURL );
						        parent.Friend.User.Login( Trim( Application.uName ), Trim( Application.uPass ), false, function( result )
						        {
							        if( result == false )
							        {
								        showLoginError();
							        }
							        else if( result == 0 )
							        {
								        setTimeout( showLoginError, 1000 );
							        }
							        else
							        {
								        Application.busy = false;
							        }
						        }, false, { hashedPassword: Application.pHash ? true : false } );
					        }
					        else
					        {
						        Application.loginAttempts++;
						        if( Application.loginAttempts < 10 ) setTimeout(Application.loginUser, 500 );
						        else showLoginError('Could not login');
					        }
					    }
					    // Auth2faToken not registered, show 2fa form
					    else
					    {
					    	ge( 'LoginElement' ).classList.add( 'Faded' );
					    	let u = new cAjax();
						    u.open( 'POST', '/loginprompt/?get2faform=1', true );
					        u.onload = function()
					        {
					            ge( 'LoginElement' ).innerHTML = this.responseText();
					            ge( 'LoginElement' ).classList.remove( 'Faded' );
					        }
					        u.send();
					    }
					}
					m.send();
				}				
			};
			

			
			function showLoginError(msg)
			{
				document.getElementById( 'invalidLogin' ).getElementsByTagName( 'p' )[0].innerHTML = (msg ? msg : 'Invalid credentials. Please check you  input.' );
				Application.failedAttempt = true;
				Application.busy = false;
			}
		</script>
	</body>
</html>
