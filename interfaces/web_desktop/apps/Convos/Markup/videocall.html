
	<div id="VideoArea">
		<video id="VideoStream" autoplay muted></video>
		<video id="RemoteVideoStream" autoplay></video>
	</div>
	<div id="Toolbar">
		<input type="hidden" id="peerId"/>
		<input type="hidden" id="currentPeerId" value="{peerId}"/>
		<div class="Buttons">
			<div class="NiceButton HangUp"></div>
			<div class="NiceButton Vision"></div>
			<div class="NiceButton Mute"></div>
		</div>
	</div>
	<script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
	<style>
		#VideoArea, #VideoArea > video
		{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			transition: opacity 0.2s;
		}
		#VideoArea > video
		{
			object-fit: cover;
		}
		#VideoArea > #RemoteVideoStream,
		#VideoArea > #RemoteVideoStream.Hidden,
		#VideoArea.Connected > #RemoteVideoStream.Hidden
		{
			opacity: 0;
			pointer-events: none;
		
		}
		#VideoArea.Connected > #RemoteVideoStream
		{
			opacity: 1;
			pointer-events: all;
		}
		#VideoArea.Connected > #VideoStream
		{
			opacity: 0;
			pointer-events: none;
		}
		#Toolbar
		{
			position: absolute;
			bottom: 15px;
			left: 0;
			height: 50px;
			width: 100%;
		}
		#Toolbar > .Buttons
		{
			position: absolute;
			background-color: rgba(0,0,0,0.8);
			border-radius: 50px;
			left: calc(50% - 75px);
			bottom: 0;
			width: 150px;
			overflow: hidden;
			display: flex;
		}
		#Toolbar > .Buttons > .NiceButton
		{
			flex: 1;
			min-width: 50px;
			height: 50px;
			line-height: 50px;
			text-align: center;
			color: white;
			cursor: pointer;
		}
		#Toolbar > .Buttons > .NiceButton:hover
		{
			background-color: rgba(255,255,255,0.3);
		}
		#Toolbar > .Buttons > .NiceButton.HangUp:before
		{
			font-size: 30px;
			content: "\f095";
			transform: rotate(45deg);
			font-family: fontawesome;
		}
		#Toolbar > .Buttons > .NiceButton.Mute:before
		{
			font-size: 30px;
			content: "\f130";
			font-family: fontawesome;
		}
		#Toolbar > .Buttons > .NiceButton.Mute.Muted:before
		{
			font-size: 30px;
			content: "\f131";
			font-family: fontawesome;
		}
		#Toolbar > .Buttons .NiceButton.Vision:before
		{
			font-size: 30px;
			content: "\f06e";
			font-family: fontawesome;
		}
		#Toolbar > .Buttons .NiceButton.Vision.Muted:before
		{
			font-size: 30px;
			content: "\f070";
			font-family: fontawesome;
		}
	</style>
	<script>
		// Just a global peer object
		window.peer = false;
		
		document.querySelector( '.HangUp' ).onclick = function(){ CloseView(); }
		document.querySelector( '.Mute' ).onclick = function()
		{
			let s = this;
			navigator.mediaDevices.getUserMedia( { video: true, audio: true } )
			.then( ( stream ) => {
				localStream = stream;
				const localVideo = document.getElementById( 'VideoStream' );
				localVideo.srcObject = stream;
				const localAudioTrack = localStream.getAudioTracks()[0];
				if( localAudioTrack )
				{
				  	if( s.classList.contains( 'Muted' ) )
					{
						s.classList.remove( 'Muted' );
						localAudioTrack.enabled = true;
					}
					else
					{
						s.classList.add( 'Muted' );
						localAudioTrack.enabled = false;
					}
				}
			} )
			.catch( ( error ) => {
				console.error( 'Error accessing media devices:', error );
			} );
		};
		document.querySelector( '.Vision' ).onclick = function()
		{
			let s = this;
			navigator.mediaDevices.getUserMedia( { video: true, audio: true } )
			.then( ( stream ) => {
				localStream = stream;
				const localVideo = document.getElementById( 'VideoStream' );
				localVideo.srcObject = stream;
				const localVideoTrack = localStream.getVideoTracks()[0];
				if( localVideoTrack )
				{
				  	if( s.classList.contains( 'Muted' ) )
					{
						s.classList.remove( 'Muted' );
						localVideoTrack.enabled = true;
					}
					else
					{
						s.classList.add( 'Muted' );
						localVideoTrack.enabled = false;
					}
				}
			} )
			.catch( ( error ) => {
				console.error( 'Error accessing media devices:', error );
			} );
		};
		
		Application.receiveMessage = function( msg )
		{
			if( msg.command == 'initcall' && msg.peerId == ge( 'peerId' ).value )
			{
				if( !window.peer )
				{
					return setTimeout( function()
					{
						Application.receiveMessage( msg );
					}, 100 );
				}
				const localVideoStream = ge( 'VideoStream' ).srcObject;
				const c = peer.call( msg.remotePeerId, localVideoStream );
				c.on( 'stream', ( remoteStream ) => {
					ge( 'VideoArea' ).classList.remove( 'Loading' );
					ge( 'VideoArea' ).classList.add( 'Connected' );
					const remoteVideo = ge( 'RemoteVideoStream' );
					remoteVideo.srcObject = remoteStream;
					initStreamEvents( remoteVideo );
					
					// In case of reconnects (this happens when remote goes away)
					remoteVideo.classList.remove( 'Hidden' );
				} );
				c.on( 'error', ( err ) => {
					console.log( 'Error with connecting to remote stream.', err );
				} );
			}
		}
		Application.run = function()
		{
			let self = this;
			
			peer = new Peer();
			peer.on( 'error', ( err ) => {
				console.log( 'Peer error: ', err );
			} );
			peer.on( 'disconnected', ( err ) => {
				console.log( 'Peer disconnected: ', err );
			} );
			peer.on( 'open', (peerId) => {
				ge( 'peerId' ).value = peerId;
			  
				const localVideo = ge( 'VideoStream' );
				navigator.mediaDevices.getUserMedia( { video: true, audio: true } )
					.then( ( stream ) => {
						localVideo.srcObject = stream;
						peer.on( 'call', ( c ) => {
							// Answer the call and display remote stream
							c.answer( stream );
							c.on( 'stream', ( remoteStream ) => {
								ge( 'VideoArea' ).classList.remove( 'Loading' );
								ge( 'VideoArea' ).classList.add( 'Connected' );
								const remoteVideo = ge( 'RemoteVideoStream' );
								remoteVideo.srcObject = remoteStream;
								initStreamEvents( remoteVideo );
							} );
						} );
						peer.on( 'error', ( err ) => {
							console.log( 'Error with calling remote.', err );
						} );
					} )
					.catch( ( error ) => {
						console.error( 'Error accessing media devices:', error );
					} );
				if( !ge( 'currentPeerId' ).value )
				{
					self.sendMessage( {
						command: 'broadcast-call',
						peerId: ge( 'peerId' ).value
					} );
				}
				else
				{
					ge( 'VideoStream' ).parentNode.classList.add( 'Loading' );
					
					Application.sendMessage( {
						command: 'broadcast-received',
						peerId: ge( 'currentPeerId' ).value,
						remotePeerId: ge( 'peerId' ).value
					} );
				}
			} );
		}
		function handleRemoteStreamEnded( e )
		{
			if( e.type == 'mute' )
			{
				const remoteVideo = ge( 'RemoteVideoStream' );
				remoteVideo.classList.add( 'Hidden' );
				console.log( 'mute: ', e );
			}
			else
			{
				console.log( 'End: ', e );
			}
			
		}
		function handleRemoteStreamMuted( e )
		{
			if( e.type == 'mute' )
			{
				const remoteVideo = ge( 'RemoteVideoStream' );
				remoteVideo.classList.add( 'Hidden' );
				console.log( 'mute 2: ', e );
			}
			else
			{
				console.log( 'End: ', e );
			}
		}
		function initStreamEvents( obj )
		{
			/*peer.on( 'mute', ( err ) => {
				console.log( 'Mute - event with remote stream.', err );
			} );
			peer.on( 'ended', ( err ) => {
				console.log( 'Ended - event with remote stream.', err );
			} );*/
			
			obj.srcObject.getTracks().forEach( ( track ) => {
			  track.onended = handleRemoteStreamEnded;
			  track.onmute = handleRemoteStreamMuted;
			  track.onerror = function( e )
			  {
			  	console.log( 'What is it?', e );
			  }
			});
		}
  </script>

